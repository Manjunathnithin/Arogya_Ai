<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AarogyaAI Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <header>
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <h1>AarogyaAI | {{ user.user_type | upper }} Dashboard</h1>
            <form action="/users/logout" method="post" style="display: inline;">
                <button type="submit">Log Out</button>
            </form>
        </div>
    </header>

    <div class="container dashboard-layout">
        <aside class="sidebar">
            <h3 style="margin-top: 0; color: #4f46e5;">Welcome, {{ user.first_name }}!</h3>
            <p><strong>Email:</strong> {{ user.email }}</p>
            <p><strong>Role:</strong> {{ user.user_type | capitalize }}</p>
            <hr>

            <h4 style="color: #4f46e5;">Features</h4>
            <ul>
                {% if is_patient %}
                <li><a href="#chat-section">AI Assistant</a></li>
                <li><a href="#connect-doctor">Connect with Doctor</a></li>
                <li><a href="#reports">Medical Records</a></li>
                <li><a href="#appointments">Appointments</a></li>
                {% endif %}

                {% if is_doctor %}
                <li><a href="#chat-section">AI Assistant</a></li>
                <li><a href="#pending-requests">Connection Requests</a></li>
                <li><a href="#my-patients">My Patients</a></li>
                {% endif %}
            </ul>
        </aside>

        <main class="main-content">
            <h2 id="chat-section">AI Medical Assistant</h2>
            
            <div id="chat-history-container" style="height: 50vh;">
                <div class="flex flex-col items-center justify-center h-full text-gray-400 text-xs italic space-y-2">
                    <span>Loading chat history...</span>
                </div>
            </div>

            <form id="chat-form" class="chat-input-area">
                <input type="text" id="query-input" name="query" placeholder="Ask a medical question or analyze your records..." required>
                <button type="submit" name="action" value="ask">Ask</button>
                
                {% if is_patient %}
                <button type="submit" name="action" value="summarize" style="background-color: #3b82f6;">Summarize Records</button>
                {% endif %}
            </form>

            <hr style="margin: 20px 0;">

            {% if is_patient %}
            
            <h3 id="connect-doctor" style="color: #4f46e5;">Connect with a Doctor</h3>
            <p>Enter a doctor's email to share your records with them.</p>
            <form id="connection-form" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="email" id="doctor-email-input" name="doctor_email" placeholder="Doctor's Email (e.g., dr.strange@arogya.ai)" required 
                    style="padding: 10px; border: 1px solid #ccc; border-radius: 4px; flex-grow: 1;">
                <button type="submit" style="background-color: #8b5cf6;">Send Request</button>
            </form>
            <div id="connection-message"></div>
            <hr>

            <h3 id="reports" style="color: #4f46e5;">Submit New Medical Report</h3>
            <p>Use this form to add a record of a blood test, prescription, or other report.</p>
            
            <form id="report-form" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                <input type="text" name="title" placeholder="Report Title (e.g., Annual Blood Panel)" required 
                    style="padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                
                <select name="report_type" required style="padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    <option value="">-- Select Report Type --</option>
                    <option value="Blood Test">Blood Test</option>
                    <option value="Imaging Scan">Imaging Scan (MRI/X-Ray)</option>
                    <option value="Prescription">Prescription</option>
                    <option value="Consultation Notes">Consultation Notes</option>
                    <option value="Other">Other</option>
                </select>
                
                <textarea name="description" placeholder="Key findings or detailed notes (optional)" rows="3"
                    style="padding: 10px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                
                <button type="submit" style="background-color: #10b981;">Submit Report</button>
                <div id="report-message" style="margin-top: 5px; font-size: 0.9em;"></div>
            </form>
        
            <h3 style="color: #4f46e5;">My Uploaded Reports</h3>
            <div id="reports-list-container" style="border: 1px solid #e0e0e0; padding: 15px; border-radius: 4px;">
                <p style="text-align: center; color: #777;">Loading medical reports...</p>
            </div>
            {% endif %}

            {% if is_doctor %}
            
            <h3 id="pending-requests" style="color: #4f46e5;">Incoming Connection Requests</h3>
            <div id="requests-container" style="margin-bottom: 20px;">
                <p>Loading requests...</p>
            </div>
            <hr>

            <h3 id="my-patients" style="color: #4f46e5;">My Connected Patients</h3>
            <div id="patients-list-container">
                <p>Loading patients...</p>
            </div>
            
            {% endif %}
            
        </main>
    </div>

    <script src="/static/app.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const userType = "{{ user.user_type }}";

        // --- PATIENT LOGIC ---
        if (userType === 'patient') {
            const connForm = document.getElementById('connection-form');
            if (connForm) {
                connForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const docEmail = document.getElementById('doctor-email-input').value;
                    const msgDiv = document.getElementById('connection-message');
                    msgDiv.innerHTML = "Sending...";

                    try {
                        const response = await fetch('/connections/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ doctor_email: docEmail, patient_email: "{{ user.email }}" })
                        });

                        if (response.ok) {
                            msgDiv.innerHTML = '<span style="color:green">Request sent successfully!</span>';
                            connForm.reset();
                        } else {
                            const err = await response.json();
                            msgDiv.innerHTML = `<span style="color:red">Error: ${err.detail}</span>`;
                        }
                    } catch (error) {
                        msgDiv.innerHTML = '<span style="color:red">Network error.</span>';
                    }
                });
            }
        }

        // --- DOCTOR LOGIC ---
        if (userType === 'doctor') {
            loadPendingRequests();
            loadConnectedPatients();
        }

        // 1. Load Requests
        async function loadPendingRequests() {
            const container = document.getElementById('requests-container');
            try {
                const response = await fetch('/connections/pending');
                if (response.ok) {
                    const requests = await response.json();
                    if (requests.length === 0) {
                        container.innerHTML = '<p style="color:#777; font-style:italic;">No pending requests.</p>';
                        return;
                    }
                    
                    container.innerHTML = requests.map(req => `
                        <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; background-color: #f9fafb;">
                            <div>
                                <strong>${req.patient_email}</strong><br>
                                <span style="font-size: 0.8em; color: #555;">Requested: ${new Date(req.request_date).toLocaleDateString()}</span>
                            </div>
                            <button onclick="acceptRequest('${req.id}')" style="background-color: #10b981; color: white; padding: 5px 10px; border:none; border-radius:4px; cursor:pointer;">Accept</button>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error(e);
            }
        }

        // 2. Load Patients (UPDATED with "View" button)
        async function loadConnectedPatients() {
            const container = document.getElementById('patients-list-container');
            try {
                const response = await fetch('/doctor/patients');
                if (response.ok) {
                    const patients = await response.json();
                    if (patients.length === 0) {
                        container.innerHTML = '<p style="color:#777;">No connected patients yet.</p>';
                        return;
                    }
                    // Render list with "View Records" button
                    container.innerHTML = `<ul style="list-style:none; padding:0;">${patients.map(email => `
                        <li style="background:white; border:1px solid #eee; padding:10px; margin-bottom:8px; border-radius:4px; display:flex; justify-content:space-between; align-items:center;">
                            <span>${email}</span>
                            <button onclick="viewPatientReports('${email}')" style="background-color:#4f46e5; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.9em;">
                                View Records
                            </button>
                        </li>
                    `).join('')}</ul>
                    <div id="patient-reports-display" style="margin-top:20px; border-top:2px dashed #ccc; padding-top:10px; display:none;">
                        </div>`;
                }
            } catch (e) {
                console.error(e);
            }
        }

        // 3. Accept Request Action
        window.acceptRequest = async function(requestId) {
            if (!confirm("Accept this patient connection?")) return;
            try {
                const response = await fetch(`/connections/${requestId}/accept`, { method: 'PUT' });
                if (response.ok) {
                    alert("Connected!");
                    loadPendingRequests();
                    loadConnectedPatients();
                } else {
                    alert("Failed to accept.");
                }
            } catch (e) { console.error(e); }
        }

        // 4. View Patient Reports Action (NEW)
        window.viewPatientReports = async function(patientEmail) {
            const displayArea = document.getElementById('patient-reports-display');
            displayArea.style.display = 'block';
            displayArea.innerHTML = `<h4 style="color:#4f46e5;">Medical Records for: ${patientEmail}</h4><p>Loading...</p>`;
            
            try {
                // Fetch reports using the route we already have in doctor_routes.py
                const response = await fetch(`/doctor/patients/${patientEmail}/reports`);
                
                if (response.ok) {
                    const reports = await response.json();
                    
                    if (reports.length === 0) {
                        displayArea.innerHTML += '<p>No records found for this patient.</p>';
                        return;
                    }

                    // Render the reports (Re-using the style from app.js)
                    const reportsHtml = reports.map(report => `
                        <div style="border: 1px solid #ccc; margin-bottom: 10px; padding: 10px; border-radius: 6px; background-color: #fff;">
                            <strong>${report.title}</strong> 
                            <span style="float: right; font-size: 0.8em; color: #777;">${new Date(report.upload_date).toLocaleDateString()}</span>
                            <p style="margin: 5px 0 0; font-size: 0.9em;">Type: ${report.report_type}</p>
                            ${report.description ? `<p style="font-size: 0.9em; color: #555; margin-top: 5px; background:#f9f9f9; padding:5px;">${report.description}</p>` : ''}
                        </div>
                    `).join('');

                    displayArea.innerHTML = `<h4 style="color:#4f46e5;">Medical Records for: ${patientEmail}</h4>` + reportsHtml;
                    
                    // Scroll to view
                    displayArea.scrollIntoView({ behavior: 'smooth' });

                } else {
                    displayArea.innerHTML = '<p style="color:red;">Error fetching reports. You might not be authorized.</p>';
                }
            } catch (e) {
                console.error(e);
                displayArea.innerHTML = '<p style="color:red;">Network error.</p>';
            }
        }
    });
    </script>
</body>
</html>