<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AarogyaAI Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <style>
        /* Pulse animation for recording state (Kept inline as it's CSS-in-JS related) */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording {
            animation: pulse 1.5s infinite;
            background-color: #dc2626 !important;
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <h1>AarogyaAI | {{ user.user_type | upper }} Dashboard</h1>
            <form action="/users/logout" method="post">
                <button type="submit" class="btn-red">Log Out</button>
            </form>
        </div>
    </header>

    <div class="container dashboard-layout">
        <aside class="sidebar">
            <h3 style="color: var(--primary-color);">Welcome, {{ user.first_name }}!</h3>
            <p><strong>Email:</strong> {{ user.email }}</p>
            <p><strong>Role:</strong> {{ user.user_type | capitalize }}</p>
            <hr>

            <h4>Menu</h4>
            <ul>
                <li><a href="#chat-section">AI Assistant</a></li>
                <li><a href="#appointments-section">Appointments</a></li>

                {% if is_patient %}
                <li><a href="#connect-doctor">Connect with Doctor</a></li>
                <li><a href="#submit-report">Upload Reports</a></li>
                <li><a href="#my-reports">My Records</a></li>
                {% endif %}

                {% if is_doctor %}
                <li><a href="#pending-requests">Connection Requests</a></li>
                <li><a href="#my-patients">My Patients</a></li>
                {% endif %}
            </ul>
        </aside>

        <main class="main-content">
            
            <h2 id="chat-section">AI Medical Assistant</h2>
            
            <div id="chat-history-container">
                <div class="flex flex-col items-center justify-center h-full text-gray-400 text-xs italic space-y-2">
                    <span>Loading chat history...</span>
                </div>
            </div>

            <form id="chat-form" class="chat-input-area">
                <input type="text" id="query-input" name="query" placeholder="Ask a medical question..." required>
                
                <button type="button" id="voice-btn" class="btn-red" style="width: 45px; border-radius: 50%; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;" title="Hold to Speak">
                    ðŸŽ¤
                </button>

                <button type="submit" name="action" value="ask">Ask</button>
                
                {% if is_patient %}
                <button type="submit" name="action" value="summarize" class="btn-secondary">Summarize Records</button>
                {% endif %}
            </form>
            <p id="voice-status" style="font-size: 0.8em; color: #666; margin-top: 5px; height: 1.2em; font-style: italic;"></p>

            <hr style="margin: 30px 0;">

            {% if is_patient %}
            
            <h3 id="connect-doctor" style="color: var(--primary-color);">Connect with a Doctor</h3>
            <p>Share your medical records with a doctor by entering their email.</p>
            <form id="connection-form" class="chat-input-area" style="gap: 10px; margin-bottom: 20px;">
                <input type="email" id="doctor-email-input" name="doctor_email" placeholder="Doctor's Email (e.g., doctor@test.com)" required style="flex-grow: 1;">
                <button type="submit" class="btn-secondary" style="background-color: #8b5cf6;">Send Request</button>
            </form>
            <div id="connection-message"></div>
            <hr>

            <h3 id="submit-report" style="color: var(--primary-color);">Submit New Medical Report</h3>
            <form id="report-form" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;"> 
                <input type="text" name="title" placeholder="Report Title (e.g., Annual Blood Panel)" required>
                
                <select name="report_type" required>
                    <option value="">-- Select Report Type --</option>
                    <option value="Blood Test">Blood Test</option>
                    <option value="Imaging Scan">Imaging Scan (MRI/X-Ray)</option>
                    <option value="Prescription">Prescription</option>
                    <option value="Consultation Notes">Consultation Notes</option>
                    <option value="Other">Other</option>
                </select>
                
                <textarea name="description" placeholder="Key findings or detailed notes (optional)" rows="3"></textarea>
                
                <button type="submit" class="btn-success">Submit & Analyze</button>
                <div id="report-message" style="margin-top: 5px; font-size: 0.9em;"></div>
            </form>
        
            <h3 id="my-reports" style="color: var(--primary-color);">My Uploaded Reports</h3>
            <div id="reports-list-container" class="data-list-container">
                <p style="text-align: center; color: #777;">Loading medical reports...</p>
            </div>
            {% endif %}


            {% if is_doctor %}
            
            <h3 id="pending-requests" style="color: var(--primary-color);">Incoming Connection Requests</h3>
            <div id="requests-container" style="margin-bottom: 20px;"><p>Loading requests...</p></div>
            <hr>

            <h3 id="my-patients" style="color: var(--primary-color);">My Connected Patients</h3>
            <div id="patient-search-controls" style="margin-bottom: 15px;">
                <input type="text" id="patient-search-input" placeholder="Search by patient email..." style="width: 100%;">
            </div>
            <div id="patients-list-container"><p>Loading patients...</p></div>
            
            <div id="patient-reports-display" class="section-card" style="padding-top:10px; display:none; margin-top:20px;">
                </div>
            {% endif %}


            <hr style="margin: 30px 0;">
            <h2 id="appointments-section" style="color: var(--primary-color);">Appointments</h2>

            {% if is_patient %}
            <div class="section-card">
                <h4>Book Appointment</h4>
                <form id="appointment-form" style="display: grid; gap: 15px; max-width: 100%;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 0.9em; color: #555;">Doctor's Email:</label>
                            <input type="email" name="doctor_email" placeholder="e.g. doctor@test.com" required>
                        </div>
                        <div>
                            <label style="font-size: 0.9em; color: #555;">Date & Time:</label>
                            <input type="datetime-local" name="appointment_time" required>
                        </div>
                    </div>
                    
                    <div>
                        <label style="font-size: 0.9em; color: #555;">Reason / Title:</label>
                        <input type="text" name="title" placeholder="e.g., Follow-up on Blood Test" required>
                    </div>

                    <button type="submit" class="btn-secondary">Schedule Appointment</button>
                    <div id="appt-message" style="margin-top: 5px; font-size: 0.9em;"></div>
                </form>
            </div>
            {% endif %}

            <h3>Upcoming Schedule</h3>
            <div id="appointments-list-container" class="data-list-container">
                <p>Loading schedule...</p>
            </div>

        </main>
    </div>

    <script src="/static/app.js"></script>
   
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userType = "{{ user.user_type }}";
            let allPatients = []; // Global variable to store all connected patients
    
            // ================= VOICE RECORDING LOGIC (Remains the same) =================
            const voiceBtn = document.getElementById('voice-btn');
            const voiceStatus = document.getElementById('voice-status');
            const queryInput = document.getElementById('query-input');
            let mediaRecorder;
            let audioChunks = [];
    
            if (voiceBtn) {
                voiceBtn.addEventListener('mousedown', startRecording);
                voiceBtn.addEventListener('mouseup', stopRecording);
                voiceBtn.addEventListener('mouseleave', stopRecording);
                voiceBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startRecording(); });
                voiceBtn.addEventListener('touchend', (e) => { e.preventDefault(); stopRecording(); });
            }
    
            async function startRecording() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert("Microphone not supported.");
                    return;
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    mediaRecorder.start();
                    
                    voiceStatus.innerText = "Listening... ðŸ”´";
                    voiceBtn.classList.add("recording");
                } catch (err) {
                    console.error("Mic Error:", err);
                    voiceStatus.innerText = "Mic access denied.";
                }
            }
    
            function stopRecording() {
                if (!mediaRecorder || mediaRecorder.state === "inactive") return;
                mediaRecorder.stop();
                voiceStatus.innerText = "Processing...";
                voiceBtn.classList.remove("recording");
    
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); 
                    const formData = new FormData();
                    formData.append("audio_file", audioBlob, "recording.webm");
    
                    try {
                        const response = await fetch('/transcribe', { method: 'POST', body: formData });
                        if (response.ok) {
                            const data = await response.json();
                            if (data.text) {
                                queryInput.value = data.text;
                                voiceStatus.innerText = "Transcribed!";
                            } else {
                                voiceStatus.innerText = "Could not hear you.";
                            }
                        } else {
                            voiceStatus.innerText = "Transcription failed.";
                        }
                    } catch (e) {
                        voiceStatus.innerText = "Network error.";
                    }
                    setTimeout(() => voiceStatus.innerText = "", 2000);
                };
            }
    
            // ================= APPOINTMENTS & CONNECTIONS =================
            loadAppointments();
    
            if (userType === 'patient') {
                // Connection Request (JSON Submission)
                const connForm = document.getElementById('connection-form');
                if (connForm) {
                    connForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const docEmail = document.getElementById('doctor-email-input').value;
                        const msgDiv = document.getElementById('connection-message');
                        msgDiv.innerHTML = "Sending...";
                        try {
                            const response = await fetch('/connections/', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ doctor_email: docEmail })
                            });
                            if (response.ok) {
                                msgDiv.innerHTML = '<span style="color:green">Request sent!</span>';
                                connForm.reset();
                            } else {
                                const error = await response.json();
                                let detail = error.detail || 'Unknown error.';
                                if (error.detail && Array.isArray(error.detail)) {
                                    detail = error.detail.map(d => `${d.loc.slice(-1)[0]} is required or invalid.`).join(' | ');
                                }
                                msgDiv.innerHTML = `<span style="color:red">Error: ${detail}</span>`;
                            }
                        } catch (error) { msgDiv.innerHTML = '<span style="color:red">Network error.</span>'; }
                    });
                }
    
                // Book Appointment (JSON Submission)
                const apptForm = document.getElementById('appointment-form');
                if (apptForm) {
                    apptForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const formData = new FormData(apptForm);
                        const data = Object.fromEntries(formData.entries());
                        const msg = document.getElementById('appt-message');
                        if(data.appointment_time) data.appointment_time = new Date(data.appointment_time).toISOString();
    
                        try {
                            const response = await fetch('/appointments/', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            });
                            if (response.ok) {
                                msg.innerHTML = '<span style="color:green">Scheduled!</span>';
                                apptForm.reset();
                                loadAppointments();
                            } else {
                                const error = await response.json();
                                let detail = error.detail || 'Unknown error.';
                                if (error.detail && Array.isArray(error.detail)) {
                                    detail = error.detail.map(d => `${d.loc.slice(-1)[0]} is required or invalid.`).join(' | ');
                                }
                                msg.innerHTML = `<span style="color:red">Error: ${detail}</span>`;
                            }
                        } catch (error) { msg.innerHTML = '<span style="color:red">Network error.</span>'; }
                    });
                }
            }
    
            if (userType === 'doctor') {
                loadPendingRequests();
                loadConnectedPatients();
                
                const searchInput = document.getElementById('patient-search-input');
                if (searchInput) {
                    searchInput.addEventListener('keyup', filterPatients);
                }
            }
            
            // --- DOCTOR FUNCTIONS ---
            
            function renderPatientList(patientsToRender) {
                const container = document.getElementById('patients-list-container');
                if (patientsToRender.length === 0) {
                     container.innerHTML = '<p style="color:#777;">No matching patients found.</p>';
                     return;
                }
                container.innerHTML = `<ul style="list-style:none; padding:0;">${patientsToRender.map(email => `
                    <li style="background:white; border:1px solid #eee; padding:10px; margin-bottom:8px; border-radius:4px; display:flex; justify-content:space-between; align-items:center;">
                        <span>${email}</span>
                        <button onclick="viewPatientReports('${email}')" class="btn-secondary" style="background-color: var(--primary-color); padding:5px 10px;">View Records</button>
                    </li>`).join('')}</ul>`;
            }
            
            function filterPatients() {
                const searchTerm = document.getElementById('patient-search-input').value.toLowerCase();
                const filtered = allPatients.filter(email => 
                    email.toLowerCase().includes(searchTerm)
                );
                renderPatientList(filtered);
            }
    
            async function loadConnectedPatients() {
                const container = document.getElementById('patients-list-container');
                try {
                    const response = await fetch('/doctor/patients');
                    if (response.ok) {
                        const patients = await response.json();
                        allPatients = patients;
                        renderPatientList(patients);
                    }
                } catch (e) { container.innerHTML = '<p style="color:red;">Failed to load patients.</p>'; }
            }
    
            async function loadPendingRequests() {
                const container = document.getElementById('requests-container');
                try {
                    const response = await fetch('/connections/pending');
                    if (response.ok) {
                        const requests = await response.json();
                        container.innerHTML = requests.length ? requests.map(req => `
                            <div style="border:1px solid #ccc; padding:10px; margin-bottom:10px; border-radius:5px; display:flex; justify-content:space-between; align-items:center; background:#f9fafb;">
                                <div><strong>${req.patient_email}</strong><br><small>${new Date(req.request_date).toLocaleDateString()}</small></div>
                                <button onclick="acceptRequest('${req.id}')" class="btn-success" style="padding:5px 10px;">Accept</button>
                            </div>`).join('') : '<p style="color:#777;">No pending requests.</p>';
                    }
                } catch (e) { console.error(e); }
            }
    
            window.acceptRequest = async function(requestId) {
                if (!confirm("Accept?")) return;
                try {
                    const response = await fetch(`/connections/${requestId}/accept`, { method: 'PUT' });
                    if (response.ok) { alert("Connected!"); loadPendingRequests(); loadConnectedPatients(); }
                } catch (e) { alert("Error."); }
            }
    
            window.updateAppointmentLink = async function(appointmentId) {
                const newLink = prompt("Enter Google Meet Link:");
                if (!newLink) return;
    
                try {
                    const response = await fetch(`/appointments/${appointmentId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ meeting_link: newLink })
                    });
    
                    if (response.ok) {
                        alert("Meeting link updated!");
                        loadAppointments(); // Refresh the list
                    } else {
                        alert("Failed to update link.");
                    }
                } catch (e) {
                    alert("Network error.");
                }
            }
    
    
            window.viewPatientReports = async function(patientEmail) {
                const displayArea = document.getElementById('patient-reports-display');
                displayArea.style.display = 'block';
                displayArea.innerHTML = `<h3 style="color:var(--primary-color); margin-top:0;">Detailed View for: ${patientEmail}</h3><p>Loading...</p>`;
                
                try {
                    const [reportsResponse, apptsResponse] = await Promise.all([
                        fetch(`/doctor/patients/${patientEmail}/reports`),
                        fetch(`/doctor/patients/${patientEmail}/appointments`)
                    ]);
    
                    const reports = reportsResponse.ok ? await reportsResponse.json() : [];
                    const appointments = apptsResponse.ok ? await apptsResponse.json() : [];
                    
                    let contentHtml = `<h4 style="color:var(--primary-color);">Medical Records (${reports.length})</h4>`;
    
                    if (reports.length === 0) {
                        contentHtml += '<p>No medical records found for this patient.</p>';
                    } else {
                        contentHtml += reports.map(r => `
                            <div class="report-card">
                                <div style="display:flex; justify-content:space-between;">
                                    <strong class="card-title">${r.title}</strong> 
                                    <span style="font-size: 0.8em; color: #777;">${new Date(r.upload_date).toLocaleDateString()}</span>
                                </div>
                                <small class="tag-type">${r.report_type}</small>
                                ${r.description ? `<div style="font-size:0.9em; color:#4b5563; margin-top:8px; background:#f3f4f6; padding:8px; border-radius:4px;">${r.description}</div>` : ''}
                            </div>`).join('');
                    }
    
                    contentHtml += `<h4 style="color:var(--primary-color); margin-top: 20px;">Appointments (${appointments.length})</h4>`;
    
                    if (appointments.length === 0) {
                        contentHtml += '<p>No appointments found with you.</p>';
                    } else {
                        contentHtml += appointments.map(a => `
                            <div class="appointment-card" style="border-left: 4px solid var(--primary-color);">
                                <div style="display:flex; justify-content:space-between;">
                                    <strong>${a.title}</strong>
                                    <span style="color: var(--primary-color); font-weight:bold;">${new Date(a.appointment_time).toLocaleString()}</span>
                                </div>
                                <small style="text-transform: capitalize; color: var(--success-color);">Status: ${a.status}</small>
                                ${userType === 'doctor' ? 
                                    (a.status === 'scheduled' ? 
                                    `<button onclick="updateAppointmentLink('${a.id}')" class="btn-secondary" style="background-color: orange; margin-top: 10px; padding: 5px 10px;">Add Meet Link</button>`
                                    : '') 
                                    : ''}
                            </div>`).join('');
                    }
    
                    displayArea.innerHTML = `<h3 style="color:var(--primary-color); margin-top:0;">Detailed View for: ${patientEmail}</h3>` + contentHtml;
                    displayArea.scrollIntoView({ behavior: 'smooth' });
    
                } catch (e) {
                    console.error("View Patient Reports Error:", e);
                    displayArea.innerHTML = `<h3 style="color:var(--primary-color); margin-top:0;">Detailed View for: ${patientEmail}</h3><p style="color:red;">Error loading patient data.</p>`;
                }
            }
    
    
            async function loadAppointments() {
                const container = document.getElementById('appointments-list-container');
                try {
                    const response = await fetch('/appointments/');
                    if (response.ok) {
                        const appts = await response.json();
                        container.innerHTML = appts.length ? appts.map(a => `
                            <div style="border-left:4px solid var(--primary-color); background:white; padding:10px; margin-bottom:10px; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                                <div style="display:flex; justify-content:space-between;"><strong>${a.title}</strong><span style="color:var(--primary-color);">${new Date(a.appointment_time).toLocaleString()}</span></div>
                                <small>${a.doctor_email ? 'Doctor: '+a.doctor_email : 'Patient: '+a.patient_email} | Status: ${a.status}</small>
                                ${a.meeting_link && a.status === 'scheduled' ? 
                                    `<a href="${a.meeting_link}" target="_blank" class="btn-secondary" style="background-color: var(--success-color); padding: 5px 10px; margin-top: 10px; text-align: center;">Join Google Meet</a>`
                                    : ''}
                                ${userType === 'doctor' && a.status === 'scheduled' && !a.meeting_link ? 
                                    `<button onclick="updateAppointmentLink('${a.id}')" class="btn-secondary" style="background-color: orange; margin-top: 10px; padding: 5px 10px;">Add Meet Link</button>`
                                    : ''}
                            </div>`).join('') : '<p style="color:#777;">No appointments.</p>';
                    }
                } catch (e) { container.innerHTML = '<p>Error.</p>'; }
            }
        });
        </script>
    </body>
    </html>